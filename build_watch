#!/usr/bin/env bash

# Load rust config vars
source "$HOME/.cargo/env"

# Create Wii SD card to use with emulation.
pre_build () {
    rm -rf bin/*
    dd if=/dev/zero bs=1M count=2048 of=bin/sd.raw
    mkfs.fat -F 32 bin/sd.raw
    echo -e "\e[1;32m Build initialized. \e[0m"
}

# Build function
build () {
    cargo +nightly build -Z build-std=core,alloc --target powerpc-unknown-eabi.json --release
    cp target/powerpc-unknown-eabi/release/rust-wii.elf bin/boot.elf
    cp bin/boot.elf bin/boot.dol
    echo -e "\e[1;32m Binary build completed. \e[0m"
}

# Update Wii SD card
update_sd () {
    sudo mount -o defaults,umask=000 bin/sd.raw /media/sdcard
    rm -rf /media/sdcard/*
    mkdir /media/sdcard/apps
    cp -r homebrew-channel/* /media/sdcard/apps/
    cp bin/boot.elf /media/sdcard/apps/boot.elf
    sudo umount /media/sdcard
    echo -e "\e[1;32m Updated SD card. \e[0m"
}

# Run script
echo -e "\e[1;34m Starting initial build... \e[0m"
pre_build
build
update_sd
echo -e "\e[1;34m Watch started. \e[0m"
inotifywait -mq -r -e create -e modify -e delete -e move ./src |
    while read dir action file; do
        echo -e "\e[1;34m The file '$file' appeared in directory '$dir' via '$action', rebuilding... \e[0m"
        build
        update_sd
    done
